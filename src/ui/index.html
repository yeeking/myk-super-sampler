<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sampler</title>
  <style>
    :root {
      --bg: #f1f2f5;
      --panel: #e0e2e6;
      --panel-stroke: #c6c8cc;
      --accent: #556070;
      --text: #1b1c1f;
      --muted: #6c7078;
      --button: #d8dbe0;
      --button-stroke: #a6a9af;
      --wave: #424751;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px 24px 32px;
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1160px;
      margin: 0 auto;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }

    h1 {
      letter-spacing: 0.8px;
      font-weight: 700;
      font-size: 28px;
    }

    .add-btn {
      background: var(--button);
      border: 2px solid var(--button-stroke);
      border-radius: 10px;
      padding: 12px 20px;
      font-weight: 600;
      letter-spacing: 0.6px;
      cursor: pointer;
      color: var(--text);
      box-shadow: 0 1px 2px var(--shadow);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px var(--shadow);
    }

    .players {
      display: grid;
      gap: 18px;
    }

    .player {
      background: var(--panel);
      border: 2px solid var(--panel-stroke);
      border-radius: 14px;
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 520px 150px 120px;
      column-gap: 16px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .controls {
      display: grid;
      grid-template-columns: 120px 70px 1fr;
      gap: 12px;
      align-items: center;
    }

    .button-stack {
      display: grid;
      gap: 10px;
    }

     .trigger-btn {
      height: 100%;
      border: 2px solid var(--button-stroke);
      border-radius: 10px;
      background: linear-gradient(180deg, #dfe2e7, #cfd3d9);
      font-weight: 800;
      letter-spacing: 0.4px;
      color: var(--text);
      cursor: pointer;
      transition: transform 120ms ease;
    }
/*
    .trigger-btn:hover {
      transform: translateY(-1px);
    }
*/
    .trigger-btn:active {
      transform: translateY(0);
    } 
    .pill-btn {
      background: var(--button);
      border: 2px solid var(--button-stroke);
      border-radius: 8px;
      font-weight: 700;
      padding: 10px 12px;
      text-align: center;
      letter-spacing: 0.4px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .pill-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 12px var(--shadow);
    }

    .waveform {
      position: relative;
      background: #ebedf1;
      border: 2px solid var(--panel-stroke);
      border-radius: 10px;
      padding: 10px 12px;
      height: 112px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .wave-inner {
      width: 100%;
      height: 100%;
    }

    .wave-inner svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .status {
      position: absolute;
      right: 12px;
      bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      text-transform: lowercase;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2f343d;
      box-shadow: 0 0 0 4px rgba(68, 73, 80, 0.18);
    }

    .file-label {
      position: absolute;
      left: 12px;
      bottom: 8px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      max-width: 70%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .range,
    .gain {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-self: center;
    }

    .label {
      font-size: 13px;
      letter-spacing: 0.6px;
      color: var(--muted);
      font-weight: 700;
    }

    .range-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #d9dce1;
      border: 2px solid #aaafb5;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--text);
      box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.08), 0 2px 5px var(--shadow);
    }

    .arrow {
      opacity: 0.6;
      font-size: 12px;
    }

    .num-input {
      width: 56px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #a9adb2;
      background: #f3f4f7;
      font-weight: 700;
      text-align: center;
      color: var(--text);
      -moz-appearance: textfield;
    }

    .num-input:focus {
      outline: 2px solid #92a0b2;
    }

    .num-input::-webkit-outer-spin-button,
    .num-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .gain-row {
      display: grid;
      grid-template-columns: 64px 1fr;
      gap: 12px;
      align-items: center;
    }

    .knob {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(145deg, #f9fafc, #cdd0d6);
      border: 2px solid #b0b3b9;
      box-shadow: inset 0 8px 12px rgba(255, 255, 255, 0.4), 0 3px 10px var(--shadow);
      position: relative;
    }

    .knob::after {
      content: "";
      position: absolute;
      width: 6px;
      height: 18px;
      background: var(--accent);
      border-radius: 4px;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) rotate(-30deg);
      transform-origin: center 16px;
    }

    .meter {
      height: 74px;
      background: linear-gradient(180deg, #d2d5da, #c3c6cc);
      border: 2px solid #b2b5bc;
      border-radius: 8px;
      padding: 6px;
      display: flex;
      align-items: flex-end;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    .meter .fill {
      width: 100%;
      height: 32%;
      background: linear-gradient(180deg, #6b727f, #3f4551);
      border-radius: 4px;
    }

    .vu {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .vu-meter {
      position: relative;
      width: 150px;
      height: 126px;
      background: #f2f4f8;
      border: 2px solid #b5b9c2;
      border-radius: 14px;
      overflow: hidden;
    }

    .vu-face {
      position: absolute;
      inset: 12px 12px 18px 12px;
      width: calc(100% - 24px);
      height: calc(100% - 30px);
    }

    .vu-needle {
      position: absolute;
      width: 4px;
      height: 74px;
      background: linear-gradient(180deg, #1f232c, #3e4554);
      bottom: 16px;
      left: 50%;
      transform-origin: 50% 90%;
      transform: translate(-50%, 0) rotate(-110deg);
      border-radius: 6px;
      transition: none;
      will-change: transform;
    }

    .vu-cap {
      position: absolute;
      width: 14px;
      height: 14px;
      background: #1e212a;
      border: 2px solid #e1e3e8;
      border-radius: 50%;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .playing * {
      transition: none !important;
      box-shadow: none !important;
    }

    .status.idle .dot {
      background: #838894;
      box-shadow: 0 0 0 2px rgba(131, 136, 148, 0.2);
    }

    .status.playing .dot {
      background: #2d313a;
      box-shadow: 0 0 0 4px rgba(45, 49, 58, 0.25);
    }

    .status.loaded .dot {
      background: #2f934b;
      box-shadow: 0 0 0 4px rgba(47, 147, 75, 0.22);
      color: #2f934b;
    }

    .status.recording .dot {
      background: #c43b4d;
      box-shadow: 0 0 0 4px rgba(196, 59, 77, 0.24);
      color: #c43b4d;
    }

    @media (max-width: 860px) {
      .player {
        grid-template-columns: 1fr;
        row-gap: 14px;
      }

      .controls {
        grid-template-columns: 160px 1fr;
      }

      .gain-row {
        grid-template-columns: 64px 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1>SAMPLER</h1>
      <button class="add-btn">ADD SAMPLE PLAYER</button>
    </header>

    <main class="players" id="players"></main>
  </div>

  <script>
    const state = { players: [] };
    const vuNeedles = new Map();
    const playerEls = new Map();
    const lastVuAngles = new Map();
    const VU_MIN_DB = -20;
    const VU_MAX_DB = 3;

    const playersEl = document.getElementById("players");
    const addBtn = document.querySelector(".add-btn");
    let vuTimer = null;

    function vuDbToDeg(db) {
      const clamped = Math.max(VU_MIN_DB, Math.min(VU_MAX_DB, db));
      const norm = (clamped - VU_MIN_DB) / (VU_MAX_DB - VU_MIN_DB);
      return -110 + norm * 220;
    }

    function buildVuTicks() {
      const stops = [-20, -15, -10, -7, -5, -3, -1, 0, 1, 2, 3];
      const cx = 100;
      const cy = 96;
      const outer = 80;
      const inner = 64;
      return stops
        .map((db) => {
          const rad = (vuDbToDeg(db) * Math.PI) / 180;
          const x1 = cx + Math.cos(rad) * outer;
          const y1 = cy + Math.sin(rad) * outer;
          const x2 = cx + Math.cos(rad) * inner;
          const y2 = cy + Math.sin(rad) * inner;
          return `<line x1="${x1.toFixed(2)}" y1="${y1.toFixed(2)}" x2="${x2.toFixed(2)}" y2="${y2.toFixed(2)}" />`;
        })
        .join("");
    }

    addBtn?.addEventListener("click", async () => {
      try {
        await fetch("/addSamplePlayer", { method: "POST" });
        console.log('addButton called addSamplePlayer')
      } catch (err) {
        console.error("Failed to add sample player", err);
      }
    });

    function createPlayerElement(p) {
      const section = document.createElement("section");
      section.className = "player";
      const ticks = buildVuTicks();
      section.innerHTML = `
        <div class="controls">
          <div class="button-stack">
            <button class="pill-btn load-btn" data-id="${p.id}">LOAD</button>
            <button class="pill-btn" data-action="record" data-id="${p.id}">REC...</button>
          </div>
          <button class="trigger-btn" data-id="${p.id}">▶</button>
          <div class="waveform">
            <div class="wave-inner"></div>
            <div class="status idle">
              <span class="dot"></span>
              <span>idle</span>
            </div>
            <div class="file-label">${p.fileName || "No file loaded"}</div>
          </div>
        </div>
        <div class="range">
          <span class="label">MIDI NOTE RANGE</span>
          <div class="range-pill">
            <input type="number" min="0" max="127" class="num-input start-note">
            <span class="arrow">▶</span>
            <input type="number" min="0" max="127" class="num-input end-note">
          </div>
        </div>
        <div class="vu">
          <span class="label">VU METER</span>
          <div class="vu-meter" data-id="${p.id}">
            <svg class="vu-face" viewBox="0 0 200 120" aria-hidden="true">
              <path d="M20 96 A80 80 0 0 1 180 96" fill="none" stroke="#2f343f" stroke-width="3" stroke-linecap="round" />
              <path d="M120 96 A60 60 0 0 1 175 96" fill="none" stroke="#d54c3f" stroke-width="4" stroke-linecap="round" />
              <g stroke="#2f343f" stroke-width="2" stroke-linecap="round">
                ${ticks}
              </g>
              <text x="36" y="70" font-size="11" fill="#2f343f" font-weight="700">-20</text>
              <text x="70" y="54" font-size="11" fill="#2f343f" font-weight="700">-10</text>
              <text x="100" y="46" font-size="11" fill="#2f343f" font-weight="700">-5</text>
              <text x="130" y="50" font-size="11" fill="#2f343f" font-weight="700">0</text>
              <text x="154" y="62" font-size="11" fill="#2f343f" font-weight="700">+3</text>
              <text x="90" y="82" font-size="12" fill="#2f343f" font-weight="800">VU</text>
            </svg>
            <div class="vu-needle"></div>
            <div class="vu-cap"></div>
          </div>
        </div>
      `;

      const loadBtn = section.querySelector(".load-btn");
      loadBtn?.addEventListener("click", async (e) => {
        const id = e.currentTarget.getAttribute("data-id");
        try { await fetch(`/loadSample?id=${id}`, { method: "POST" }); }
        catch (err) { console.error("Load request failed", err); }
      });

      const trigBtn = section.querySelector(".trigger-btn");
      trigBtn?.addEventListener("click", async (e) => {
        const id = e.currentTarget.getAttribute("data-id");
        try { await fetch(`/trigger?id=${id}`, { method: "POST" }); }
        catch (err) { console.error("Trigger request failed", err); }
      });

      const start = section.querySelector(".start-note");
      const end = section.querySelector(".end-note");
      const clamp = (v) => Math.min(127, Math.max(0, v));
      const commit = () => {
        let low = clamp(parseInt(start.value, 10) || 0);
        let high = clamp(parseInt(end.value, 10) || 0);
        if (low > high) high = low;
        if (high < low) low = high;
        start.value = low;
        end.value = high;
        const id = p.id;
        fetch(`/setRange?id=${id}&low=${low}&high=${high}`, { method: "POST" }).catch((err) => {
          console.error("Failed to set range", err);
        });
      };
      const maybeCommitOnEnter = (ev) => { if (ev.key === "Enter") { ev.preventDefault(); ev.currentTarget.blur(); } };
      start?.addEventListener("blur", commit);
      end?.addEventListener("blur", commit);
      start?.addEventListener("keydown", maybeCommitOnEnter);
      end?.addEventListener("keydown", maybeCommitOnEnter);

      const refs = {
        section,
        statusEl: section.querySelector(".status"),
        statusText: section.querySelector(".status span:last-child"),
        fileLabel: section.querySelector(".file-label"),
        wave: section.querySelector(".wave-inner"),
        start,
        end,
        needle: section.querySelector(".vu-needle"),
        waveSig: "",
      };

      vuNeedles.set(p.id, refs.needle);
      return refs;
    }

    function updatePlayerElement(refs, p) {
      const statusClass = p.status === "loaded" ? "loaded" : p.isPlaying ? "playing" : "idle";
      const statusLabel = p.status || (p.isPlaying ? "playing" : "idle");
      if (refs.statusEl) {
        refs.statusEl.className = `status ${statusClass}`;
        refs.statusText.textContent = statusLabel;
      }
      const desiredFile = p.fileName || "No file loaded";
      if (refs.fileLabel && refs.fileLabel.textContent !== desiredFile)
        refs.fileLabel.textContent = desiredFile;
      if (refs.start && Number(refs.start.value) !== p.midiLow) refs.start.value = p.midiLow;
      if (refs.end && Number(refs.end.value) !== p.midiHigh) refs.end.value = p.midiHigh;

      if (refs.wave && p.waveformSVG && refs.waveSig !== p.waveformSVG) {
        refs.wave.innerHTML = p.waveformSVG;
        const svg = refs.wave.querySelector("svg");
        if (svg) svg.setAttribute("preserveAspectRatio", "none");
        refs.waveSig = p.waveformSVG;
      }
    }

    function renderPlayers() {
      if (!state.players.length) {
        playerEls.clear();
        vuNeedles.clear();
        lastVuAngles.clear();
        playersEl.innerHTML = "";
        const empty = document.createElement("div");
        empty.textContent = "No sample players yet. Click \"Add Sample Player\" to begin.";
        empty.style.color = "var(--muted)";
        empty.style.fontWeight = "600";
        empty.style.padding = "8px 4px";
        playersEl.appendChild(empty);
        document.body.classList.remove("playing");
        return;
      }

      if (playerEls.size === 0) playersEl.innerHTML = "";

      const seen = new Set();
      state.players.forEach((p) => {
        let refs = playerEls.get(p.id);
        if (!refs) {
          refs = createPlayerElement(p);
          playerEls.set(p.id, refs);
          playersEl.appendChild(refs.section);
        }
        updatePlayerElement(refs, p);
        seen.add(p.id);
      });

      for (const [id, refs] of playerEls.entries()) {
        if (!seen.has(id)) {
          playersEl.removeChild(refs.section);
          playerEls.delete(id);
          vuNeedles.delete(id);
          lastVuAngles.delete(id);
        }
      }

      const anyPlaying = state.players.some((p) => p.isPlaying);
      document.body.classList.toggle("playing", anyPlaying);
    }

    function handleCppMessage(data) {
      try {
        if (data?.players) {
          state.players = data.players;
          renderPlayers();
        } else if (data?.msg) {
          console.log("Message from backend:", data.msg);
        }
      } catch (err) {
        console.error("Failed to handle message", err);
      } finally {
        if (window.__JUCE__?.emitResult) {
          window.__JUCE__.emitResult("ok");
        }
      }
    }

    async function fetchVu() {
      try {
        const res = await fetch("/vuState");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const values = json?.dB_out || [];
        values.forEach((vu, idx) => {
          const player = state.players[idx];
          if (!player) return;
          const needle = vuNeedles.get(player.id);
          if (!needle) return;
          const deg = vuDbToDeg(vu);
          const last = lastVuAngles.get(player.id);
          if (last !== undefined && Math.abs(last - deg) < 0.25) return;
          lastVuAngles.set(player.id, deg);
          needle.style.transform = `translate(-50%, 0) rotate(${deg}deg)`;
        });
      } catch (err) {
        console.error("Failed to fetch VU data", err);
      }
    }

    function startVuPolling(rate) {
      if (vuTimer) clearInterval(vuTimer);
      const clampedRate = Math.min(rate || 10, 20);
      const intervalMs = Math.max(40, Math.floor(1000 / clampedRate));
      vuTimer = setInterval(fetchVu, intervalMs);
    }

    async function fetchInitialState() {
      try {
        const res = await fetch("/state");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json?.players) {
            state.players = json.players;
            renderPlayers();
        }
      } catch (err) {
        console.error("Failed to fetch initial state", err);
        renderPlayers();
      }
    }

    fetchInitialState();
    startVuPolling(10);
  </script>
</body>
</html>
